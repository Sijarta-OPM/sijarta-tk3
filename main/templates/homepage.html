{% extends 'base.html' %}
{% block content %}

{% if logged_in %}
    <div class="min-h-screen bg-gray-50 p-8">
        <div class="max-w-5xl mx-auto">
            <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                <h2 class="text-3xl text-center font-bold mb-6">Pencarian Jasa</h2>
                
                <div class="space-y-4">
                    <!-- First Dropdown -->
                    <form id="search-subkategori-form">
                        <div class="space-y-2">
                            <label for="kategori-jasa" class="block text-sm font-medium text-gray-700">
                                Kategori Jasa
                            </label>
                            <select
                                id="kategori-jasa"
                                name="kategori-jasa"
                                class="block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                            >
                                <option value="">Semua Kategori</option>
                                {% if kategori_jasa %}
                                    {% for kategori in kategori_jasa %}
                                        <option value="{{ kategori.1 }}">{{ kategori.1 }}</option>
                                    {% endfor %}
                                {% endif %}
                            </select>
                        </div>
                        
                        <!-- delete Second Dropdown because its supposed to be search -->
                        <label 
                        for="text"
                        class="block text-gray-700 font-medium mb-2"
                        >Subkategori Jasa</label>
                        <input 
                        id="subkategori-jasa"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        type="text"
                        placeholder="Subkategori jasa">
                        
                        <!-- Search Button -->
                        <button 
                        type="submit" 
                        id="search-button"
                        class="w-full mt-4 px-4 py-2 bg-blue-600 text-white font-medium rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                        >
                        Search
                    </button>
                </div>
            </div>
        </form>

            <div id="queryResult" class="pt-6" data-url-pattern="{% url 'subkategori:show_subkategori' '00000000-0000-0000-0000-000000000000' %}">
                <!-- Initial content will be loaded by JavaScript -->
            </div>
        </div>
    </div>

    <script>                
        // Search button functionality
        const kategoriSelect = document.getElementById('')
        const searchSubkategoriForm = document.getElementById('search-subkategori-form')

        searchSubkategoriForm.addEventListener('submit', function(e){
            e.preventDefault();

            const selectedKategoriJasa = document.getElementById('kategori-jasa').value;
            const querySubkategoriJasa = document.getElementById('subkategori-jasa').value;
            queryResult.innerHTML = '';
            
            
            const url = '/api/search-subkategori/';
            fetch(url, {
                method: 'POST',
                headers : {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}' 
                },
                body : JSON.stringify({
                    kategoriJasa : selectedKategoriJasa,
                    subkategoriJasa : querySubkategoriJasa
                })
            })
            .then(response => response.json())
            .then(data => {
                // after getting the result, then show the result in div with id query result
                // but what kind of result we suppose to get
                // data that is fetched is in json format
                // console.log(data.data);
                for (const key in data.data){
                    // console.log(key, data.data[key])
                    renderKategoriCard(key, data.data[key])
                    data.data[key].forEach(element => {
                        console.log(element['namasubkategori']);
                        
                    });
                }
            })
            .catch((error) => {
                console.error('Error:', error);
            });
        })
        

        function fetchSubkategori() {
            const kategoriId = kategoriSelect.value;
            const subkategoriId = subkategoriSelect.value;
            
            // Clear existing content
            queryResult.innerHTML = '';
            
        }

        function getKategoriName(kategoriId) {
            const option = kategoriSelect.querySelector(`option[value="${kategoriId}"]`);
            return option ? option.textContent : '';
        }

        function renderKategoriCard(kategoriId, subkategories) {
            const urlPattern = queryResult.dataset.urlPattern;
            const kategoriName = subkategories[0]['namakategori']
            const cardHTML = `
                <div class="bg-white rounded-lg shadow-md mb-6 p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">${kategoriName}</h2>
                    <div class="flex flex-col space-y-2">
                        ${subkategories.map(sub => `
                            <a href="${urlPattern.replace('00000000-0000-0000-0000-000000000000', sub['idsubkategori'])}" 
                               class="p-3 rounded-md hover:bg-blue-50 text-blue-600 hover:text-blue-700 transition-colors duration-200 border-b border-gray-100 last:border-b-0">
                                ${sub['namasubkategori']}
                            </a>
                        `).join('')}
                    </div>
                </div>
            `;
            queryResult.insertAdjacentHTML('beforeend', cardHTML);
        }
    </script>
{% else %}
    <p class="text-center py-4">Silahkan login terlebih dahulu</p>
{% endif %}
{% endblock content %}