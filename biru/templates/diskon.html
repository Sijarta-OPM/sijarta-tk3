{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="bg-gray-100 min-h-screen p-6">
    <div class="max-w-4xl mx-auto">
        <div class="bg-white shadow-lg rounded-lg overflow-hidden">
            <div class="p-6">
                <h1 class="text-3xl font-bold text-center text-gray-800 mb-8">VOUCHER</h1>
                
                <div class="grid md:grid-cols-2 gap-6">
                    {% for v in voucher %}
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 transform transition hover:scale-105">
                        <div class="space-y-4">
                            <div class="flex justify-between items-center">
                                <span class="text-lg font-semibold text-gray-700">Kode:</span>
                                <span class="text-sm font-bold text-blue-600">{{ v.0 }}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Hari Aktif:</span>
                                <span class="text-blue-500">{{ v.1 }} hari</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Minimal Pembelian:</span>
                                <span class="text-green-600">Rp {{ v.2 }}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Potongan:</span>
                                <span class="text-red-500">{{ v.3 }}%</span>
                            </div>
                            <button data-kode-voucher="{{v.0}}" data-harga-voucher="{{v.3}}" class="beli-voucher w-full bg-blue-500 text-white py-2 rounded-md hover:bg-blue-600 transition">
                                Beli Voucher
                            </button>
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-center text-gray-500">Tidak ada voucher tersedia</p>
                    {% endfor %}
                </div>
            </div>

            <div class="bg-gray-50 p-6">
                <h1 class="text-3xl font-bold text-center text-gray-800 mb-8">PROMO</h1>
                
                <div class="grid md:grid-cols-2 gap-6">
                    {% for p in promo %}
                    <div class="bg-green-50 border border-green-200 rounded-lg p-6 transform transition hover:scale-105">
                        <div class="space-y-4">
                            <div class="flex justify-between items-center">
                                <span class="text-lg font-semibold text-gray-700">Kode Promo:</span>
                                <span class="text-sm font-bold text-green-600">{{ p.0 }}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Berlaku hingga:</span>
                                <span class="text-red-500">{{ p.1 }}</span>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-center text-gray-500">Tidak ada promo tersedia</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
<div id="voucherModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg p-8 w-96">
        <h2 class="text-2xl font-bold mb-6 text-center">Beli Voucher</h2>
        <form id="voucherPurchaseForm">
            <div class="mb-4">
                <label for="paymentMethod" class="block text-gray-700 font-bold mb-2">Pilih Metode Pembayaran</label>
                <select 
                    id="paymentMethod" 
                    name="payment_method" 
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                    {% for metode in metode_bayar %}
                        <option value="{{metode.0}}">{{metode.1}}</option>
                    {% endfor %}
                    
                </select>
            </div>
            <button 
                type="submit" 
                class="w-full bg-blue-500 text-white py-2 rounded-md hover:bg-blue-600 transition"
            >
                Lanjutkan Pembayaran
            </button>
        </form>
        <button 
            id="closeModal" 
            class="w-full mt-4 text-gray-600 hover:text-gray-800 transition"
        >
            Batal
        </button>
    </div>
</div>

<div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg p-8 w-3/4 h-3/4 text-center">
        <div class="mb-6">
            <svg class="mx-auto mb-4 w-16 h-16 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <h2 class="text-2xl font-bold text-gray-800">Pembelian Berhasil!</h2>
        </div>
        
        <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
            <div class="flex justify-between items-center mb-2">
                <span class="text-gray-600">Kode Voucher:</span>
                <span id="successVoucherCode" class="font-bold text-green-600"></span>
            </div>
            <div class="flex justify-between items-center mb-2">
                <span class="text-gray-600">Berlaku Hingga:</span>
                <span id="successVoucherExpiry" class="text-blue-600"></span>
            </div>
            <div class="flex justify-between items-center">
                <span class="text-gray-600">Jumlah Penggunaan:</span>
                <span id="successVoucherUsage" class="text-red-500"></span>
            </div>
        </div>
        
        <button 
            id="closeSuccessModal" 
            class="w-full bg-blue-500 text-white py-2 rounded-md hover:bg-blue-600 transition"
        >
            Tutup
        </button>
    </div>
</div>

<div id="failureModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg p-8 w-3/4 h-3/4 text-center">
        <div class="mb-6">
            <svg class="mx-auto mb-4 w-16 h-16 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <h2 class="text-2xl font-bold text-gray-800">Pembelian Gagal</h2>
        </div>
        
        <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
            <p id="failureReason" class="text-red-700 text-center"></p>
        </div>
        
        <button 
            id="closeFailureModal" 
            class="w-full bg-red-500 text-white py-2 rounded-md hover:bg-red-600 transition"
        >
            Tutup
        </button>
    </div>
</div>

<script>
    function showSuccessModal(voucher) {
        const successModal = document.getElementById('successModal');
        const voucherCodeEl = document.getElementById('successVoucherCode');
        const voucherExpiryEl = document.getElementById('successVoucherExpiry');
        const voucherUsageEl = document.getElementById('successVoucherUsage');

        // Update modal content
        voucherCodeEl.textContent = voucher[0]; // Voucher ID/Code
        
        // Calculate and format expiry date
        const today = new Date();
        const expiryDate = new Date(today.getTime() + (voucher[1] * 24 * 60 * 60 * 1000));
        voucherExpiryEl.textContent = expiryDate.toLocaleDateString('id-ID');
        
        // Usage times
        voucherUsageEl.textContent = voucher[2] + ' kali';

        // Show the modal
        successModal.classList.remove('hidden');
    }

    function showFailureModal(reason) {
        const failureModal = document.getElementById('failureModal');
        const failureReasonEl = document.getElementById('failureReason');

        // Set failure reason
        failureReasonEl.textContent = reason || 'Terjadi kesalahan dalam pembelian voucher';

        // Show the modal
        failureModal.classList.remove('hidden');
    }

    document.querySelectorAll('.beli-voucher').forEach(button => {
        button.addEventListener('click', function(){
            const kodevoucher = this.getAttribute('data-kode-voucher');
            const hargavoucher = this.getAttribute('data-harga-voucher');
            
            // Show modal
            document.getElementById('voucherModal').classList.remove('hidden');
        });
    });

    // Close modal functionality
    document.getElementById('closeModal').addEventListener('click', function() {
        document.getElementById('voucherModal').classList.add('hidden');
    });

    // Form submission
    document.getElementById('voucherPurchaseForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const paymentMethod = document.getElementById('paymentMethod').value;
        
        if (!paymentMethod) {
            alert('Silakan pilih metode pembayaran');
            return;
        }

        const url = "{% url 'biru:beli_voucher' %}";
        const kodevoucher = document.querySelector('.beli-voucher[data-kode-voucher]').getAttribute('data-kode-voucher');
        const hargavoucher = document.querySelector('.beli-voucher[data-harga-voucher]').getAttribute('data-harga-voucher');

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                kode_voucher: kodevoucher,
                harga_voucher: hargavoucher,
                payment_method: paymentMethod
            })
        })
        .then(response => response.json())
        .then(data => {
            // Handle success (e.g., show success message, redirect)
            if (data['buy_status'])
            showSuccessModal(data['voucher'])
                // alert('Pembelian voucher berhasil');
            else
                showFailureModal("no money");
            document.getElementById('voucherModal').classList.add('hidden');
        })
        .catch(error => {
            // Handle error
            console.error('Error:', error);
            alert('Terjadi kesalahan dalam pembelian voucher');
        });
    });
    document.getElementById('closeSuccessModal').addEventListener('click', function() {
        document.getElementById('successModal').classList.add('hidden');
    });
    // Close failure modal functionality
    document.getElementById('closeFailureModal').addEventListener('click', function() {
        document.getElementById('failureModal').classList.add('hidden');
    });
</script>
{% endblock content %}